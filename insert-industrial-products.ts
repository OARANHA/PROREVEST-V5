import { createClient } from '@supabase/supabase-js';
import * as dotenv from 'dotenv';

dotenv.config({ path: '.env.local' });

const supabase = createClient(
  process.env.VITE_SUPABASE_URL!,
  process.env.VITE_SUPABASE_ANON_KEY!
);

// Fun√ß√£o para criar slug a partir do nome
function createSlug(name: string): string {
  return name
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .replace(/[^\w\s-]/g, '')
    .replace(/\s+/g, '-')
    .replace(/--+/g, '-')
    .trim();
}

// Categorias de produtos industriais
const industrialCategories = [
  {
    name: 'Tintas Acr√≠licas',
    description: 'Tintas √† base de √°gua para uso interno e externo'
  },
  {
    name: 'Esmaltes Sint√©ticos',
    description: 'Tintas √† base de solvente para madeiras e metais'
  },
  {
    name: 'Texturas',
    description: 'Revestimentos texturizados para paredes e fachadas'
  },
  {
    name: 'Impermeabilizantes',
    description: 'Produtos para prote√ß√£o contra umidade e infiltra√ß√µes'
  },
  {
    name: 'Massas',
    description: 'Produtos para prepara√ß√£o e nivelamento de superf√≠cies'
  }
];

// Acabamentos dispon√≠veis
const industrialFinishes = [
  {
    name: 'Fosco',
    description: 'Acabamento sem brilho, ideal para disfar√ßar imperfei√ß√µes'
  },
  {
    name: 'Acetinado',
    description: 'Acabamento com brilho suave e elegante'
  },
  {
    name: 'Brilhante',
    description: 'Acabamento com alto brilho e reflexo'
  },
  {
    name: 'Semibrilho',
    description: 'Acabamento intermedi√°rio entre acetinado e brilhante'
  },
  {
    name: 'Texturizado',
    description: 'Acabamento com relevo e textura'
  }
];

// Produtos industriais baseados no cat√°logo
const industrialProducts = [
  // TINTAS ACR√çLICAS
  {
    name: 'Tinta Acr√≠lica Premium',
    description: 'Tinta acr√≠lica de alta qualidade para uso interno e externo. Excelente cobertura e durabilidade.',
    category: 'Tintas Acr√≠licas',
    finish: 'Fosco',
    technical_data: JSON.stringify({
      coverage: '12-14 m¬≤/L',
      drying_time: '30 minutos ao toque, 2 horas entre dem√£os',
      application: 'Pincel, rolo ou pistola',
      package_sizes: ['3.6L', '18L']
    }),
    is_featured: true
  },
  {
    name: 'Tinta Acr√≠lica Econ√¥mica',
    description: 'Tinta acr√≠lica com excelente custo-benef√≠cio para projetos residenciais.',
    category: 'Tintas Acr√≠licas',
    finish: 'Fosco',
    technical_data: JSON.stringify({
      coverage: '10-12 m¬≤/L',
      drying_time: '45 minutos ao toque, 3 horas entre dem√£os',
      application: 'Pincel, rolo',
      package_sizes: ['3.6L', '18L']
    }),
    is_featured: false
  },

  // ESMALTES SINT√âTICOS
  {
    name: 'Esmalte Sint√©tico Brilhante',
    description: 'Esmalte sint√©tico de alta qualidade com acabamento brilhante e prote√ß√£o superior.',
    category: 'Esmaltes Sint√©ticos',
    finish: 'Brilhante',
    technical_data: JSON.stringify({
      coverage: '14-16 m¬≤/L',
      drying_time: '2-4 horas ao toque, 12-24 horas entre dem√£os',
      application: 'Pincel, rolo ou pistola',
      package_sizes: ['900ml', '3.6L', '18L']
    }),
    is_featured: true
  },
  {
    name: 'Esmalte Sint√©tico Acetinado',
    description: 'Esmalte sint√©tico com acabamento acetinado, ideal para ambientes internos.',
    category: 'Esmaltes Sint√©ticos',
    finish: 'Acetinado',
    technical_data: JSON.stringify({
      coverage: '12-14 m¬≤/L',
      drying_time: '2-4 horas ao toque, 12-24 horas entre dem√£os',
      application: 'Pincel, rolo ou pistola',
      package_sizes: ['900ml', '3.6L', '18L']
    }),
    is_featured: false
  },

  // TEXTURAS
  {
    name: 'Textura Acr√≠lica R√∫stica',
    description: 'Textura acr√≠lica para acabamentos r√∫sticos em fachadas e muros.',
    category: 'Texturas',
    finish: 'Texturizado',
    technical_data: JSON.stringify({
      coverage: '2-4 m¬≤/L (dependendo da textura)',
      drying_time: '4-6 horas ao toque, 24 horas para secagem completa',
      application: 'Desempenadeira, rolo de espuma ou pistola',
      package_sizes: ['18L', '25kg']
    }),
    is_featured: true
  },
  {
    name: 'Textura Acr√≠lica Grafiato',
    description: 'Textura acr√≠lica para efeito grafiato em paredes internas e externas.',
    category: 'Texturas',
    finish: 'Texturizado',
    technical_data: JSON.stringify({
      coverage: '2-3 m¬≤/L',
      drying_time: '4-6 horas ao toque, 24 horas para secagem completa',
      application: 'Desempenadeira de a√ßo inox',
      package_sizes: ['18L', '25kg']
    }),
    is_featured: false
  },

  // IMPERMEABILIZANTES
  {
    name: 'Impermeabilizante Acr√≠lico',
    description: 'Impermeabilizante flex√≠vel para lajes, terra√ßos e √°reas √∫midas.',
    category: 'Impermeabilizantes',
    finish: 'Fosco',
    technical_data: JSON.stringify({
      coverage: '1-2 m¬≤/L por dem√£o',
      drying_time: '2-4 horas entre dem√£os, 72 horas para cura total',
      application: 'Rolo de l√£, trincha ou vassoura de pelo',
      package_sizes: ['3.6L', '18L']
    }),
    is_featured: true
  },
  {
    name: 'Impermeabilizante para Concreto',
    description: 'Impermeabilizante cristalizante para estruturas de concreto.',
    category: 'Impermeabilizantes',
    finish: 'Fosco',
    technical_data: JSON.stringify({
      coverage: '1 kg/m¬≤ em duas dem√£os',
      drying_time: '4-6 horas entre dem√£os, 7 dias para cura total',
      application: 'Trincha, vassoura de pelo ou pulverizador',
      package_sizes: ['4kg', '18kg']
    }),
    is_featured: false
  },

  // MASSAS
  {
    name: 'Massa Corrida PVA',
    description: 'Massa niveladora para ambientes internos.',
    category: 'Massas',
    finish: 'Fosco',
    technical_data: JSON.stringify({
      coverage: '4-6 m¬≤/L por dem√£o',
      drying_time: '3 horas entre dem√£os, 6 horas para lixamento',
      application: 'Desempenadeira de a√ßo ou esp√°tula',
      package_sizes: ['3.6L', '18L', '25kg']
    }),
    is_featured: false
  },
  {
    name: 'Massa Acr√≠lica',
    description: 'Massa niveladora para ambientes internos e externos.',
    category: 'Massas',
    finish: 'Fosco',
    technical_data: JSON.stringify({
      coverage: '4-6 m¬≤/L por dem√£o',
      drying_time: '3 horas entre dem√£os, 6 horas para lixamento',
      application: 'Desempenadeira de a√ßo ou esp√°tula',
      package_sizes: ['3.6L', '18L', '25kg']
    }),
    is_featured: true
  }
];

async function main() {
  console.log('üöÄ Iniciando inser√ß√£o de produtos industriais...');
  
  // Inserir categorias
  console.log('üìã Inserindo categorias...');
  const categoryMap = new Map();
  
  for (const category of industrialCategories) {
    // Verificar se a categoria j√° existe
    const { data: existingCategories, error: searchError } = await supabase
      .from('categories')
      .select('id, name')
      .eq('name', category.name)
      .limit(1);
      
    if (searchError) {
      console.error(`‚ùå Erro ao buscar categoria ${category.name}:`, searchError);
      continue;
    }
    
    if (existingCategories && existingCategories.length > 0) {
      console.log(`‚úÖ Categoria ${category.name} j√° existe, ID: ${existingCategories[0].id}`);
      categoryMap.set(category.name, existingCategories[0].id);
      continue;
    }
    
    // Inserir nova categoria
    const { data: newCategory, error: insertError } = await supabase
      .from('categories')
      .insert({
        name: category.name,
        description: category.description,
        is_archived: false
      })
      .select('id')
      .single();
      
    if (insertError) {
      console.error(`‚ùå Erro ao inserir categoria ${category.name}:`, insertError);
      continue;
    }
    
    console.log(`‚úÖ Categoria ${category.name} criada com ID: ${newCategory.id}`);
    categoryMap.set(category.name, newCategory.id);
  }
  
  // Inserir acabamentos
  console.log('üìã Inserindo acabamentos...');
  const finishMap = new Map();
  
  for (const finish of industrialFinishes) {
    // Verificar se o acabamento j√° existe
    const { data: existingFinishes, error: searchError } = await supabase
      .from('finishes')
      .select('id, name')
      .eq('name', finish.name)
      .limit(1);
      
    if (searchError) {
      console.error(`‚ùå Erro ao buscar acabamento ${finish.name}:`, searchError);
      continue;
    }
    
    if (existingFinishes && existingFinishes.length > 0) {
      console.log(`‚úÖ Acabamento ${finish.name} j√° existe, ID: ${existingFinishes[0].id}`);
      finishMap.set(finish.name, existingFinishes[0].id);
      continue;
    }
    
    // Inserir novo acabamento
    const { data: newFinish, error: insertError } = await supabase
      .from('finishes')
      .insert({
        name: finish.name,
        description: finish.description,
        is_archived: false
      })
      .select('id')
      .single();
      
    if (insertError) {
      console.error(`‚ùå Erro ao inserir acabamento ${finish.name}:`, insertError);
      continue;
    }
    
    console.log(`‚úÖ Acabamento ${finish.name} criado com ID: ${newFinish.id}`);
    finishMap.set(finish.name, newFinish.id);
  }
  
  // Inserir produtos
  console.log('üìã Inserindo produtos...');
  let processedProducts = 0;
  
  for (const product of industrialProducts) {
    const slug = createSlug(product.name);
    
    // Verificar se o produto j√° existe
    const { data: existingProducts, error: searchError } = await supabase
      .from('products')
      .select('id, name')
      .eq('name', product.name)
      .limit(1);
      
    if (searchError) {
      console.error(`‚ùå Erro ao buscar produto ${product.name}:`, searchError);
      continue;
    }
    
    if (existingProducts && existingProducts.length > 0) {
      console.log(`‚ö†Ô∏è Produto ${product.name} j√° existe, pulando...`);
      continue;
    }
    
    // Obter IDs de categoria e acabamento
    const categoryId = categoryMap.get(product.category);
    const finishId = finishMap.get(product.finish);
    
    if (!categoryId) {
      console.error(`‚ùå Categoria ${product.category} n√£o encontrada para o produto ${product.name}`);
      continue;
    }
    
    if (!finishId) {
      console.error(`‚ùå Acabamento ${product.finish} n√£o encontrado para o produto ${product.name}`);
      continue;
    }
    
    // Inserir novo produto
    const { data: newProduct, error: insertError } = await supabase
      .from('products')
      .insert({
        name: product.name,
        slug: slug,
        description: product.description,
        technical_data: product.technical_data,
        category_id: categoryId,
        finish_id: finishId,
        is_featured: product.is_featured,
        is_archived: false
      })
      .select('id')
      .single();
      
    if (insertError) {
      console.error(`‚ùå Erro ao inserir produto ${product.name}:`, insertError);
      continue;
    }
    
    console.log(`‚úÖ Produto ${product.name} criado com ID: ${newProduct.id}`);
    processedProducts++;
  }
  
  console.log(`üéâ Processo conclu√≠do! ${processedProducts} produtos industriais processados.`);
  
  // Verificar produtos existentes
  const { data: existingProducts, error: listError } = await supabase
    .from('products')
    .select('id, name, category_id, finish_id')
    .order('created_at', { ascending: false })
    .limit(10);
    
  if (listError) {
    console.error('‚ùå Erro ao listar produtos existentes:', listError);
  } else {
    console.log(`üìã Produtos existentes (${existingProducts?.length || 0}):`);
    existingProducts?.forEach(product => {
      console.log(`- ${product.name} (ID: ${product.id})`);
    });
  }
}

main().catch(error => {
  console.error('‚ùå Erro n√£o tratado:', error);
  process.exit(1);
});